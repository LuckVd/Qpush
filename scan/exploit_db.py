# https://www.exploit-db.com/
import datetime
import json

import requests

from obj import vuln_obj

length = 500
params = {
    'draw': '3',
    'columns[0][data]': 'date_published',
    'columns[0][name]': 'date_published',
    'columns[0][searchable]': 'true',
    'columns[0][orderable]': 'true',
    'columns[0][search][value]': '',
    'columns[0][search][regex]': 'false',
    'columns[1][data]': 'download',
    'columns[1][name]': 'download',
    'columns[1][searchable]': 'false',
    'columns[1][orderable]': 'false',
    'columns[1][search][value]': '',
    'columns[1][search][regex]': 'false',
    'columns[2][data]': 'application_md5',
    'columns[2][name]': 'application_md5',
    'columns[2][searchable]': 'true',
    'columns[2][orderable]': 'false',
    'columns[2][search][value]': '',
    'columns[2][search][regex]': 'false',
    'columns[3][data]': 'verified',
    'columns[3][name]': 'verified',
    'columns[3][searchable]': 'true',
    'columns[3][orderable]': 'false',
    'columns[3][search][value]': '',
    'columns[3][search][regex]': 'false',
    'columns[4][data]': 'description',
    'columns[4][name]': 'description',
    'columns[4][searchable]': 'true',
    'columns[4][orderable]': 'false',
    'columns[4][search][value]': '',
    'columns[4][search][regex]': 'false',
    'columns[5][data]': 'type_id',
    'columns[5][name]': 'type_id',
    'columns[5][searchable]': 'true',
    'columns[5][orderable]': 'false',
    'columns[5][search][value]': '',
    'columns[5][search][regex]': 'false',
    'columns[6][data]': 'platform_id',
    'columns[6][name]': 'platform_id',
    'columns[6][searchable]': 'true',
    'columns[6][orderable]': 'false',
    'columns[6][search][value]': '',
    'columns[6][search][regex]': 'false',
    'columns[7][data]': 'author_id',
    'columns[7][name]': 'author_id',
    'columns[7][searchable]': 'false',
    'columns[7][orderable]': 'false',
    'columns[7][search][value]': '',
    'columns[7][search][regex]': 'false',
    'columns[8][data]': 'code',
    'columns[8][name]': 'code.code',
    'columns[8][searchable]': 'true',
    'columns[8][orderable]': 'true',
    'columns[8][search][value]': '',
    'columns[8][search][regex]': 'false',
    'columns[9][data]': 'id',
    'columns[9][name]': 'id',
    'columns[9][searchable]': 'false',
    'columns[9][orderable]': 'true',
    'columns[9][search][value]': '',
    'columns[9][search][regex]': 'false',
    'order[0][column]': '9',
    'order[0][dir]': 'desc',
    'start': '0',
    'length': length,
    'search[value]': '',
    'search[regex]': 'false',
    'author': '',
    'port': '',
    'type': '',
    'tag': '',
    'platform': '',
    '_': '1685072328706'
}

cookies = {
    '$XSRF-TOKEN': 'eyJpdiI6IkY2bGRwQkR0Tkt3YStpNWVVMHQwd2c9PSIsInZhbHVlIjoiR094YVhkaFE0OUNiY0d6ZldKbU5CUUJST281Unk5S2I4OGYyWFZuWk9aZSt0Mk5PZTFQUUQ4WDA0R1VSbkd0NSIsIm1hYyI6IjczZTNjMTAxZmYzNWNhMzA2NzVjOWNiOTVlZjhmMWE3ZWM0NWJkN2UwMGVhMDMzZjUxYTkwZmE0YjQ2YjFiMDAifQ%3D%3D',
    'exploit_database_session': 'eyJpdiI6Im9jNEl5cVA1NnY4MTZmelFNMzIrYVE9PSIsInZhbHVlIjoianZ4blR3aVVyN05JSWlBbnZiKzNaSHJRV2FyelVSNjZ1eThmalQ2eDRuYWlvVXgyWmdQMFJvSWYyeUtnblhCTSIsIm1hYyI6ImEyMDRlNjc1M2JkMzQwNGUxZDUyNmExM2QzNzY3NWU1OGJhNzY2MDhiMDYyYjdkOWRiM2MxNWRlY2VmZGQ4MWYifQ%3D%3D',
    'CookieConsent': '{stamp:%27-1%27%2Cnecessary:true%2Cpreferences:true%2Cstatistics:true%2Cmarketing:true%2Cver:1%2Cutc:1597464892196%2Cregion:%27JP%27}',
    '_ga': 'GA1.3.560436933.1597464931',
    '_gid': 'GA1.3.1985101316.1597464931',
    '_gat': '1',
}

headers = {
    'Host': 'www.exploit-db.com',
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:79.0) Gecko/20100101 Firefox/79.0',
    'Accept': 'application/json, text/javascript, */*; q=0.01',
    'Accept-Language': 'zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2',
    'Accept-Encoding': 'gzip, deflate',
    'Referer': 'https://www.exploit-db.com/google-hacking-database',
    'X-Requested-With': 'XMLHttpRequest',
    'Connection': 'close',
}


def generatexls(list_data,now_date):

    oscs_list= []

    for data in list_data:
        date_time = datetime.datetime.strptime(data['date_published'], '%Y-%m-%d').date()
        if date_time <= now_date:
            break
        obj = vuln_obj()
        obj.name = data['description'][1]
        obj.url = "https://www.exploit-db.com/exploits/" + str(data['id'])
        obj.danger_level=""
        obj.type = data['type']['display']
        obj.cve = "Exploit_id-" + data['id']
        if len(data['code'])>0 and "code_type" in data['code'][0]:
            obj.cve = str(data['code'][0]['code_type']).upper() + "-" + str(data['code'][0]['code'])

        obj.cnvd = ""
        obj.find_time = data['date_published']
        obj.release_time = data['date_published']
        obj.update_time= data['date_published']

        obj.influence = ""
        obj.exp = str(1)
        obj.poc = str(1)
        obj.version = ""
        obj.description = ""
        obj.product = data['platform']['platform']
        obj.ref = ""
        obj.origin = "exploit"

        oscs_list.append(obj)

    return oscs_list




async def scan(day=1):
    response1 = requests.get('https://www.exploit-db.com', headers=headers, params=params
                             , cookies=cookies, timeout=100)

    list_data = json.loads(response1.content.decode())["data"]

    today = datetime.date.today()  # 获取当前日期
    delta = datetime.timedelta(days=day)  # 创建一个timedelta对象，表示7天
    now_date = today - delta  # 计算前7天的日期

    results = generatexls(list_data,now_date)
    return results